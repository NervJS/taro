#!/usr/bin/env node
const path = require('path')
const fs = require('fs-extra')
const program = require('commander')
const chalk = require('chalk')
const _ = require('lodash')

const build = require('../src/build')
const {
  getPkgVersion,
  PROJECT_CONFIG
} = require('../src/util')
const projectConfPath = path.join(process.cwd(), PROJECT_CONFIG)

program
  .option('--type [typeName]', 'Build type, weapp/rn/h5')
  .option('--watch', 'Build type, weapp/rn/h5')
  .parse(process.argv)

const args = program.args
const { type, watch } = program
console.log(`ğŸ‘½ Taro v${getPkgVersion()}`)
console.log()
if (!fs.existsSync(projectConfPath)) {
  console.log(chalk.red(`æ‰¾ä¸åˆ°é¡¹ç›®é…ç½®æ–‡ä»¶${PROJECT_CONFIG}ï¼Œè¯·ç¡®å®šå½“å‰ç›®å½•æ˜¯Taroé¡¹ç›®æ ¹ç›®å½•!`))
  process.exit(1)
}

if (watch) {
  process.env.NODE_ENV = 'development'
} else {
  process.env.NODE_ENV = 'production'
}
const projectConf = require(projectConfPath)(_.merge)
console.log(chalk.green(`å¼€å§‹ç¼–è¯‘é¡¹ç›® ${chalk.bold(projectConf.projectName)}`))

build(args, Object.assign(projectConf, {
  type,
  watch
}))
