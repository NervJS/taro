# yaml-language-server:$schema=./node_modules/lefthook/schema.json
# https://evilmartians.github.io/lefthook/configuration/

pre-commit:
  piped: true
  jobs:
    - name: Linting & Formatting
      group:
        parallel: true
        jobs:
          - name: biome
            glob: "*.{ts,tsx,js,jsx,mjs,mts,json,jsonc,css}"
            run: pnpm biome check --fix {staged_files} --reporter summary
            stage_fixed: true
          - name: stylelint
            glob: "*.{scss}"
            run: pnpm stylelint --fix {staged_files}
            stage_fixed: true

    # - name: QA
    #   group:
    #     parallel: true
    #     jobs:
          # - name: typecheck
          #   glob: "*.{ts,tsx}"
          #   run: pnpm tsc
          # - name: test
          #   glob: "*.{ts,tsx,js,jsx,mjs,mts,json,css,scss}"
          #   run: pnpm nx affected -t prod test:ci --files={staged_files}

prepare-commit-msg:
  commands:
    commit:
      skip:
        - run: node -e "require('fs').readFileSync('.git/COMMIT_EDITMSG','utf8').trim()||process.exit(1)"
      interactive: true
      run: pnpm git-cz --hook
      env:
        LEFTHOOK: "0"

commit-msg:
  commands:
    commitlint:
      run: pnpm commitlint --edit {1} --config commitlint.config.js

post-merge:
  follow: true
  commands:
    check-pnpm-lock:
      run: |
        if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep pnpm-lock.yaml; then
          echo pnpm-lock.yaml 已变更，请运行 pnpm install 以保持依赖一致
        fi

post-checkout:
  follow: true
  commands:
    check-pnpm-lock:
      run: |
        if [ {3} -eq 1 ]; then
          if git diff --quiet {1} {2} -- pnpm-lock.yaml; then
            echo pnpm-lock.yaml 已变更，请运行 pnpm install 以保持依赖一致
          fi
        fi
